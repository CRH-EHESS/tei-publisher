<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="odd-model.html">
<link rel="import" href="../pb-common-styles.html">

<dom-module id="odd-element-spec">
    <template>
        <style include="pb-common-styles">
            :host {
                display: block;
            }

            h1, h2, h3, h4, h5, h6 {
                font-family: "Oswald",Verdana,"Helvetica",sans-serif;
                font-weight: 400 !important;
            }

            input {
              vertical-align: middle;
            }
            .ident{
                display:inline-block;
                min-width:180px;
            }

/*
            h3{
                display:flex;
                flex-direction: column;
            }
*/
        </style>

        <h3>
            <paper-icon-button id="toggle" icon="[[toggleButtonIcon(show)]]" on-click="toggle"></paper-icon-button>
            <span class="ident">[[ ident ]]</span>
            <paper-menu-button>
                <paper-icon-button icon="add" slot="dropdown-trigger"></paper-icon-button>
                <paper-listbox id="addModel" slot="dropdown-content" on-iron-select="_addModel" attr-for-selected="value">
                    <paper-item value="model">model</paper-item>
                    <paper-item value="modelSequence">modelSequence</paper-item>
                    <paper-item value="modelGrp">modelGrp</paper-item>
                </paper-listbox>
            </paper-menu-button>

            <paper-icon-button on-click="remove" icon="delete"></paper-icon-button>
            <paper-icon-button on-click="paste" icon="content-paste"></paper-icon-button>
        </h3>

        <iron-collapse id="models" class="models" opened="{{show}}" id="elem-{{ident}}">

            <template id="modelList" is="dom-repeat" items="{{models}}" as="model">

              <odd-model behaviour="{{model.behaviour}}" predicate="{{model.predicate}}"
                type="{{model.type}}" output="{{model.output}}" css="{{model.css}}"
                models="{{model.models}}" parameters="{{model.parameters}}"
                desc="{{model.desc}}" sourcerend="{{model.sourcerend}}"
                show="{{model.show}}"
                on-model-remove="removeModel"
                on-model-move-up="moveModelUp"
                on-model-move-down="moveModelDown"
                ></odd-model>

            </template>

        </iron-collapse>

    </template>

    <script>
        /**
         * `odd-element-spec`
         *
         *
         * @customElement
         * @polymer
         * @demo demo/index.html
         */
        class OddElementSpec extends Polymer.Element {
            static get is() {
                return 'odd-element-spec';
            }

            static get properties() {
                return {
                    ident:{
                      type: String
                    },
                    mode:{
                      type: String
                    },
                    models: {
                      type: Array,
                      value: () => []
                    },
                    show: {
                      type: Boolean,
                      value: false
                    }
                };
            }

            connectedCallback() {
                super.connectedCallback();
                this.dispatchEvent(new CustomEvent('element-spec-connected', {
                  detail: {target: this}
                }));

                this.$.models.addEventListener("opened-changed", function() {
                    this.set('show', this.$.models.opened)
                    if (!this.$.models.opened) {
                      return;
                    }

                    this.dispatchEvent(new CustomEvent('element-spec-toggled', {
                      detail: {target: this}
                    }));
                }.bind(this));

                if (this.models.length === 0) {
                  this._addModel()
                }
            }

            toggleButtonIcon(show) {
              return (show ? 'expand-less' : 'expand-more')
            }

            toggle(ev) {
                this.$.models.toggle();
            }

            showModels() {
                this.$.models.show();
            }

            collapseModels() {
                this.$.models.hide();
            }

            _addModel() {
                this.$.models.show();

                this.unshift('models', {
                    behaviour: 'inline',
                    predicate: null,
                    type: this.$.addModel.selected,
                    output: null,
                    models: [],
                    parameters: [],
                    renditions: [],
                    sourcerend: false,
                    show: true
                });
            }

            removeModel(ev) {
                const item = ev.currentTarget;
                const index = this.$.modelList.indexForElement(item);
                this.splice('models', index, 1);
                // const removeModelHandler = () => {
                //     this.splice('models', index, 1);
                // };
                // this.parentNode.$.dialog
                //     .confirm('Delete?', 'Are you sure to delete the model?')
                //     .then(removeModelHandler.bind(this));
            }

            moveModelUp(ev) {
              const item = ev.currentTarget;
              const index = this.$.modelList.indexForElement(item);
              console.log('moveModelUp', item, index)

              if (index === 0) {
                return;
              }
              const model = this.get(['models', index]);
              this.splice('models', index, 1);
              this.splice('models', index-1, 0, model);
            }

            moveModelDown(ev) {
              const item = ev.currentTarget;
              const index = this.$.modelList.indexForElement(item);
              console.log('moveModelDown', item, index)

              if (index === this.models.length) {
                return;
              }
              const model = this.get(['models', index]);
              this.splice('models', index, 1);
              this.splice('models', index+1, 0, model);
            }

            _remove(ev) {
                this.dispatchEvent(new CustomEvent('element-spec-removed', {
                  detail: {target: this}
                }));
            }

            _paste(ev) {
                // TODO
                // var data = this.clipboard.paste();
                // if (data) {
                //     this.models = this.updateTag('model');
                //     this.refs.models.open();
                //     this.models.unshift(data);
                // }
            }

            serialize(indent) {
                const mode = this.mode ? ` mode="${this.mode}"`: '';
                let xml = `${indent}<elementSpec ident="${this.ident}"${mode}>\n`;
                let indent2 = indent + '    '
                xml += Array.from(this.shadowRoot.querySelectorAll('odd-model')).map(item => item.serialize(indent2)).join('')
                xml += `${indent}</elementSpec>\n`;
                return xml;
            }
        }

        window.customElements.define(OddElementSpec.is, OddElementSpec);
    </script>
</dom-module>
